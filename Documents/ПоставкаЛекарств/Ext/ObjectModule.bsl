Процедура ОбработкаПроведения(Отказ, Режим)
    Движения.ОстаткиНаСкладе.Записывать = Истина;
    
    Для Каждого ТекСтрокаПозицииЛекарств Из ПозицииЛекарств Цикл
        // Проверяем остатки по лекарству
        Запрос = Новый Запрос;
        Запрос.Текст = 
            "ВЫБРАТЬ
            |    ОстаткиНаСкладеОстатки.Партия КАК Партия,
            |    ОстаткиНаСкладеОстатки.КоличествоОстаток КАК КоличествоОстаток
            |ИЗ
            |    РегистрНакопления.ОстаткиНаСкладе.Остатки(&МоментВремени, Лекарство = &Лекарство) КАК ОстаткиНаСкладеОстатки
            |ГДЕ
            |    ОстаткиНаСкладеОстатки.КоличествоОстаток > 0
            |УПОРЯДОЧИТЬ ПО
            |    ОстаткиНаСкладеОстатки.Партия.ДатаПоступления";
        Запрос.УстановитьПараметр("Лекарство", ТекСтрокаПозицииЛекарств.Лекарство);
        Запрос.УстановитьПараметр("МоментВремени", ТекущаяДата()); // Устанавливаем параметр
        Выборка = Запрос.Выполнить().Выбрать();
        
        КоличествоКПродаже = ТекСтрокаПозицииЛекарств.Количество;
        Пока Выборка.Следующий() И КоличествоКПродаже > 0 Цикл
            КоличествоСписания = Мин(КоличествоКПродаже, Выборка.КоличествоОстаток);
            
            // Движение по регистру
            Движение = Движения.ОстаткиНаСкладе.Добавить();
            Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
            Движение.Период = Дата;
            Движение.Лекарство = ТекСтрокаПозицииЛекарств.Лекарство;
            Движение.Партия = Выборка.Партия;
            Движение.Количество = КоличествоСписания;
            Движение.ДатаПоступления = Выборка.Партия.ДатаПоступления;
            Движение.СрокГодности = Выборка.Партия.СрокГодности;
            
            // Обновляем КоличествоОстаток в справочнике ПартииЛекарств
            ПартияОбъект = Выборка.Партия.ПолучитьОбъект();
            ПартияОбъект.КоличествоОстаток = ПартияОбъект.КоличествоОстаток - КоличествоСписания;
            ПартияОбъект.Записать();
            
            КоличествоКПродаже = КоличествоКПродаже - КоличествоСписания;
        КонецЦикла;
        
        // Проверяем, хватило ли остатка
        Если КоличествоКПродаже > 0 Тогда
            Отказ = Истина;
            Сообщить("Недостаточно остатка для лекарства: " + ТекСтрокаПозицииЛекарств.Лекарство);
            Возврат;
        КонецЕсли;
    КонецЦикла;
    
    Движения.ОстаткиНаСкладе.Записать();
КонецПроцедуры  

Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// Получаем ссылку на документ "СозданиеЗаявки"
    Заявка = ЭтотОбъект.Заявка;
    // Заполняем табличную часть "ПозицииЛекарств" данными из документа "СозданиеЗаявки"
    Для Каждого СтрокаЗаявки Из Заявка.ПозицииЛекарств Цикл
        НоваяСтрока = ЭтотОбъект.ПозицииЛекарств.Добавить();
        НоваяСтрока.Лекарство = СтрокаЗаявки.Лекарство;
        НоваяСтрока.Цена = СтрокаЗаявки.Цена;
        НоваяСтрока.Количество = СтрокаЗаявки.Количество;
        НоваяСтрока.Сумма = СтрокаЗаявки.Сумма;
    КонецЦикла;
КонецПроцедуры
