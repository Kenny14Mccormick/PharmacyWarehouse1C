&НаКлиенте
Процедура ПозицииЛекарствЛекарствоПриИзменении(Элемент)
    ТекущиеДанныеСтрока = Элементы.ПозицииЛекарств.ТекущиеДанные;
    
    // Проверяем, выбрано ли лекарство
    Если ЗначениеЗаполнено(ТекущиеДанныеСтрока.Лекарство) Тогда
        // Получаем количество на складе
        КоличествоНаСкладе = ПолучитьКоличествоНаСкладе(ТекущиеДанныеСтрока.Лекарство);
        
        // Если количество меньше 15, выводим сообщение и очищаем поле
        Если КоличествоНаСкладе < 15 Тогда
            Сообщить("Лекарство " + ТекущиеДанныеСтрока.Лекарство + " отсутствует в достаточном количестве на складе. Остаток: " + КоличествоНаСкладе, СтатусСообщения.Важное);
             Объект.ПозицииЛекарств.Удалить(ТекущиеДанныеСтрока);
			 Возврат; // Прерываем выполнение процедуры
        КонецЕсли;
        
        // Если лекарство доступно, продолжаем выполнение
        Цена = ВернутьЦенуЛекарства(ТекущиеДанныеСтрока.Лекарство, Объект.Дата);
        ТекущиеДанныеСтрока.Цена = Цена;
        ТекущиеДанныеСтрока.Сумма = Цена * ТекущиеДанныеСтрока.Количество;
    КонецЕсли;
КонецПроцедуры
&НаСервере
Функция ВернутьЦенуЛекарства(Лекарство, Дата)
    Запрос = Новый Запрос;
    Запрос.Текст = 
        "ВЫБРАТЬ
        |   ЦеныНаЛекарстваСрезПоследних.Цена КАК Цена
        |ИЗ
        |   РегистрСведений.ЦеныНаЛекарства.СрезПоследних(&Дата, Лекарство = &Лекарство) КАК ЦеныНаЛекарстваСрезПоследних";
    
    Запрос.УстановитьПараметр("Дата", Дата);
    Запрос.УстановитьПараметр("Лекарство", Лекарство);
    
    РезультатЗапроса = Запрос.Выполнить();
    
    Если РезультатЗапроса.Пустой() Тогда
        Возврат 0;
    Иначе
        Выборка = РезультатЗапроса.Выбрать();
        Если Выборка.Следующий() Тогда
            Возврат Выборка.Цена;
        КонецЕсли;
    КонецЕсли;
    
    Возврат 0;
КонецФункции

&НаСервере
Функция ПолучитьКоличествоНаСкладе(Лекарство)
    Запрос = Новый Запрос;
    Запрос.Текст = 
        "ВЫБРАТЬ
        |	ОстаткиНаСкладеОстатки.КоличествоОстаток КАК Количество
        |ИЗ
        |	РегистрНакопления.ОстаткиНаСкладе.Остатки КАК ОстаткиНаСкладеОстатки
        |ГДЕ
        |	ОстаткиНаСкладеОстатки.Лекарство = &Лекарство";
    Запрос.УстановитьПараметр("Лекарство", Лекарство);
    
    РезультатЗапроса = Запрос.Выполнить();
    
    Если РезультатЗапроса.Пустой() Тогда
        Возврат 0;
    Иначе
        Выборка = РезультатЗапроса.Выбрать();
        Если Выборка.Следующий() Тогда
            Возврат Выборка.Количество;
        КонецЕсли;
    КонецЕсли;
    
    Возврат 0;
КонецФункции

&НаКлиенте
Процедура ПозицииЛекарствКоличествоПриИзменении(Элемент)
    ТекущиеДанныеСтрока = Элементы.ПозицииЛекарств.ТекущиеДанные;
    
    Попытка
        КоличествоНаСкладе = ПолучитьКоличествоНаСкладе(ТекущиеДанныеСтрока.Лекарство);
        Если ТекущиеДанныеСтрока.Количество > КоличествоНаСкладе Тогда
            Сообщить("Нельзя заказать больше " + КоличествоНаСкладе + " единиц данного лекарства.", СтатусСообщения.Обычное);
            ТекущиеДанныеСтрока.Количество = КоличествоНаСкладе;
		КонецЕсли;
        
        ТекущиеДанныеСтрока.Сумма = ТекущиеДанныеСтрока.Цена * ТекущиеДанныеСтрока.Количество;
    Исключение
        Сообщить(ОписаниеОшибки(), СтатусСообщения.Обычное);
        ТекущиеДанныеСтрока.Количество = 0;
        ТекущиеДанныеСтрока.Сумма = 0;    КонецПопытки;
	КонецПроцедуры
	
&НаКлиенте
Процедура ПоставкаЛекарств(Кнопка)
    Попытка
        // Сбрасываем модифицируемость формы перед вызовом серверной процедуры
        ЭтаФорма.Модифицированность = Ложь;
        
        // Вызов серверной процедуры и получение результата
        Результат = ПоставкаЛекарствНаСервере(Объект.Ссылка);   
        
        Если Результат <> Неопределено Тогда
            // Если есть результат (ошибка), выводим сообщение
            Сообщить(Результат, СтатусСообщения.Важное);
        Иначе
            // Если все успешно, выводим сообщение об успехе
            Сообщить("Заявка успешно выполнена", СтатусСообщения.Обычное);
            ОбновитьИнтерфейс();
            ЭтаФорма.Закрыть();
        КонецЕсли;
    Исключение
        // Обработка исключений, если они возникли
        Сообщить(ОписаниеОшибки(), СтатусСообщения.Важное);
        ЭтаФорма.Модифицированность = Ложь; // Сбрасываем модифицируемость в случае ошибки
    КонецПопытки;
КонецПроцедуры

&НаСервере
Функция ПоставкаЛекарствНаСервере(СсылкаНаЗаявку)
    // Получаем документ "СозданиеЗаявки" по ссылке
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ
    |   СозданиеЗаявки.Ссылка КАК Ссылка,
    |   СозданиеЗаявки.Аптека КАК Аптека,
    |   СозданиеЗаявки.Выполнена КАК Выполнена
    |ИЗ
    |   Документ.СозданиеЗаявки КАК СозданиеЗаявки
    |ГДЕ
    |   СозданиеЗаявки.Ссылка = &СсылкаНаЗаявку";
    
    Запрос.УстановитьПараметр("СсылкаНаЗаявку", СсылкаНаЗаявку);
    
    РезультатЗапроса = Запрос.Выполнить();
    
    Если Не РезультатЗапроса.Пустой() Тогда
        Выборка = РезультатЗапроса.Выбрать();
        Если Выборка.Следующий() Тогда
            Заявка = Выборка.Ссылка; 
            Аптека = Выборка.Аптека;
            Выполнена = Выборка.Выполнена;
        КонецЕсли;
    Иначе
        // Возвращаем текст ошибки вместо вызова исключения
        Возврат "Документ не найден.";
    КонецЕсли;
    
    // Проверяем, выполнена ли заявка
    Если Выполнена Тогда
        Возврат "Заявка уже выполнена. Создание новой поставки запрещено.";
    КонецЕсли;
    
    ТекущийПользователь = ПользователиИнформационнойБазы.ТекущийПользователь();
    Провизор =  ТекущийПользователь.ПолноеИмя;
    
    // Проверка остатков на складе
    Для Каждого СтрокаЗаявки Из Заявка.ПозицииЛекарств Цикл
        КоличествоНаСкладе = ПолучитьКоличествоНаСкладе(СтрокаЗаявки.Лекарство);
        Если СтрокаЗаявки.Количество > КоличествоНаСкладе Тогда
            Возврат "Недостаточно " + СтрокаЗаявки.Лекарство.Наименование + " на складе. Доступно: " + КоличествоНаСкладе + " единиц.";
        КонецЕсли;
    КонецЦикла;
    
    // Создаем новый документ "ПоставкаЛекарств"
    ДокументПоставка = Документы.ПоставкаЛекарств.СоздатьДокумент();
    
    // Заполняем реквизиты документа
    ДокументПоставка.Заявка = Заявка;   
    ДокументПоставка.Аптека = Аптека;           
    ДокументПоставка.Провизор = Провизор; 
    ДокументПоставка.Дата = ТекущаяДата();
    ДокументПоставка.Номер = ""; 
	
    // Заполняем табличную часть "ПозицииЛекарств" данными из текущего документа
    Для Каждого СтрокаЗаявки Из Заявка.ПозицииЛекарств Цикл
        НоваяСтрока = ДокументПоставка.ПозицииЛекарств.Добавить();
        НоваяСтрока.Лекарство = СтрокаЗаявки.Лекарство;
        НоваяСтрока.Цена = СтрокаЗаявки.Цена;
        НоваяСтрока.Количество = СтрокаЗаявки.Количество;
        НоваяСтрока.Сумма = СтрокаЗаявки.Сумма;
    КонецЦикла;
    
    // Сохраняем документ "ПоставкаЛекарств"
    ДокументПоставка.Записать(РежимЗаписиДокумента.Проведение);
    
    // Обновляем статус заявки
    ЗаявкаОбъект = Заявка.ПолучитьОбъект();
    ЗаявкаОбъект.Выполнена = Истина;
    ЗаявкаОбъект.Записать();
    
    // Если все успешно, возвращаем Неопределено
    Возврат Неопределено;
КонецФункции


&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
    // Проверяем, если поле "Аптека" уже заполнено, то ничего не делаем
    Если Не ЗначениеЗаполнено(Объект.Аптека) Тогда
        // Получаем текущего пользователя
        ТекущийПользователь = ПользователиИнформационнойБазы.ТекущийПользователь();
        ЛогинПользователя = ТекущийПользователь.Имя;

        // Создаем запрос для поиска аптеки по логину пользователя
        Запрос = Новый Запрос;
        Запрос.Текст = 
        "ВЫБРАТЬ
        |   Аптеки.Ссылка КАК Ссылка
        |ИЗ
        |   Справочник.Аптеки КАК Аптеки
        |ГДЕ
        |   Аптеки.Код_Аптеки = &КодАптеки";

        Запрос.УстановитьПараметр("КодАптеки", ЛогинПользователя);

        РезультатЗапроса = Запрос.Выполнить();
        Выборка = РезультатЗапроса.Выбрать();
        
        Если Выборка.Следующий() Тогда
            Объект.Аптека = Выборка.Ссылка;
        КонецЕсли;
	КонецЕсли;     
	
КонецПроцедуры       

