// Форма списка документов "СозданиеЗаявки"
&НаКлиенте
Процедура ПриОткрытии(Отказ)
    // Проверка роли пользователя
    РольПользователя = ПолучитьРольПользователя();
    
    Если РольПользователя = "Провизор" Тогда
        ТекстУведомления = ПроверитьНизкиеОстаткиНаСервере();
        Если Не ПустаяСтрока(ТекстУведомления) Тогда
            ПоказатьПредупреждение(, ТекстУведомления, 30, "Низкие остатки");
            // Автоматическое создание черновика заказа
            СоздатьЧерновикЗаказаНаСервере();
        КонецЕсли;
    КонецЕсли;
КонецПроцедуры

&НаСервере
Функция ПроверитьНизкиеОстаткиНаСервере()
    Попытка
        ТекстУведомления = Уведомления.ПроверитьНизкиеОстатки();
        Возврат ТекстУведомления;
    Исключение
        Сообщить("Ошибка в функции проверки остатков: " + ОписаниеОшибки());
        Возврат "";
    КонецПопытки;
КонецФункции

// Процедура для создания черновика
// Исправлено имя с Созать на Создать
&НаСервере
Процедура СоздатьЧерновикЗаказаНаСервере()
    Попытка
        Уведомления.СоздатьЧерновикЗаказаНаСклад();
        // Сообщение об успешном создании уже есть в Уведомления.СоздатьЧерновикЗаказаНаСклад
    Исключение
        Сообщить("Ошибка при создании черновика заказа: " + ОписаниеОшибки());
    КонецПопытки;
КонецПроцедуры

// Функция для проверки роли пользователя
// Возвращает "Провизор", "Админ", код аптеки или пустую строку
&НаСервере
Функция ПолучитьРольПользователя()
    ТекущийПользователь = ПользователиИнформационнойБазы.ТекущийПользователь();
    ЛогинПользователя = Строка(ТекущийПользователь.Имя);
    
    Если ЛогинПользователя = "Провизор" Тогда
        Возврат "Провизор";
    ИначеЕсли ЛогинПользователя = "Админ" Тогда
        Возврат "Админ";
    Иначе
        Возврат ЛогинПользователя; // Возвращаем код аптеки для фильтрации
    КонецЕсли;
КонецФункции

// Фильтрация по аптеке
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
    РольПользователя = ПолучитьРольПользователя();
    КодАптеки = ?(РольПользователя = "Провизор" ИЛИ РольПользователя = "Админ", "", РольПользователя);
    
    Если Не ПустаяСтрока(КодАптеки) Тогда
        ЭлементОтбора = Список.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
        ЭлементОтбора.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Аптека.Код_Аптеки");
        ЭлементОтбора.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
        ЭлементОтбора.ПравоеЗначение = КодАптеки;
        ЭлементОтбора.Использование = Истина;
    КонецЕсли;
КонецПроцедуры