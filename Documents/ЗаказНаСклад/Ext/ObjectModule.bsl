Процедура ОбработкаПроведения(Отказ, РежимПроведения)
    // Создаём папку для поставки
    ПапкаПоставки = Справочники.ПартииЛекарств.НайтиПоНаименованию(Строка(ЭтотОбъект.Ссылка));
    Если ПапкаПоставки.Пустая() Тогда
        ПапкаПоставкиОбъект = Справочники.ПартииЛекарств.СоздатьГруппу();
        ПапкаПоставкиОбъект.Наименование = "Поставка " + Формат(ЭтотОбъект.Дата, "ДФ=dd.MM.yyyy") + " (" + Строка(ЭтотОбъект.Ссылка) + ")";
        ПапкаПоставкиОбъект.Записать();
        ПапкаПоставки = ПапкаПоставкиОбъект.Ссылка;
    КонецЕсли;
    
    Для Каждого СтрокаЗаказа Из ЭтотОбъект.ПозицииЛекарств Цикл
        // Создаём новую партию
        НоваяПартия = Справочники.ПартииЛекарств.СоздатьЭлемент();
        НоваяПартия.Родитель = ПапкаПоставки; // Указываем папку
        НоваяПартия.Лекарство = СтрокаЗаказа.Лекарство;
        НоваяПартия.ДатаПоступления = ЭтотОбъект.Дата;
        
        // Расчёт срока годности
        Запрос = Новый Запрос;
        Запрос.Текст = 
            "ВЫБРАТЬ Лекарства.ТиповойСрокГодности КАК ТиповойСрокГодности 
             |ИЗ Справочник.Лекарства КАК Лекарства 
             |ГДЕ Лекарства.Ссылка = &Лекарство";
        Запрос.УстановитьПараметр("Лекарство", СтрокаЗаказа.Лекарство);
        Выборка = Запрос.Выполнить().Выбрать();
        Если Выборка.Следующий() И Не ПустаяСтрока(Выборка.ТиповойСрокГодности) Тогда
            ЧислоМесяцев = Число(Лев(Выборка.ТиповойСрокГодности, СтрНайти(Выборка.ТиповойСрокГодности, " ") - 1)) * 12;
            НоваяПартия.СрокГодности = ДобавитьМесяц(НоваяПартия.ДатаПоступления, ЧислоМесяцев);
        Иначе
            НоваяПартия.СрокГодности = ДобавитьМесяц(НоваяПартия.ДатаПоступления, 24);
        КонецЕсли;
        
        НоваяПартия.КоличествоНачальное = СтрокаЗаказа.Количество;
        НоваяПартия.КоличествоОстаток = СтрокаЗаказа.Количество;
        НоваяПартия.Записать();
        
        // Обновляем регистр ОстаткиНаСкладе
        Движение = Движения.ОстаткиНаСкладе.Добавить();
        Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
        Движение.Период = ЭтотОбъект.Дата;
        Движение.Лекарство = СтрокаЗаказа.Лекарство;
        Движение.Партия = НоваяПартия.Ссылка;
        Движение.Количество = СтрокаЗаказа.Количество;
        Движение.ДатаПоступления = НоваяПартия.ДатаПоступления;
        Движение.СрокГодности = НоваяПартия.СрокГодности;
    КонецЦикла;
    
    Движения.ОстаткиНаСкладе.Записать();
КонецПроцедуры

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
УникальныеЗаписи = Новый Соответствие();
Для Каждого ТекСтрока Из ПозицииЛекарств Цикл
		Если УникальныеЗаписи.Получить(ТекСтрока.Лекарство) <> Неопределено Тогда
		Отказ = Истина;
		Сообщить("Лекарство '" + ТекСтрока.Лекарство + "' уже существует в документе.");
	Прервать;
	КонецЕсли;
		УникальныеЗаписи.Вставить(ТекСтрока.Лекарство, Истина);
	КонецЦикла;


	Если ЭтотОбъект.ПозицииЛекарств.Количество() = 0 Тогда
	Отказ = Истина;
	Сообщить("Запись не может быть пустой.");
Возврат;
КонецЕсли;
КонецПроцедуры