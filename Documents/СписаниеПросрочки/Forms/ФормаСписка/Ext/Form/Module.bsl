// Модуль формы списка документа СписаниеПросрочки

// Клиентская часть: обработка команды
&НаКлиенте
Процедура СписатьПросрочку(Команда)
    Успешно = Ложь;
    СписатьПросроченныеЛекарстваНаСервере(Успешно);
    
    // Обновляем список, если списание прошло успешно
    Если Успешно Тогда
        Элементы.Список.Обновить();
    КонецЕсли;
КонецПроцедуры

// Серверная часть: логика списания
&НаСервере
Процедура СписатьПросроченныеЛекарстваНаСервере(Успешно)
    ТекущаяДатаСеанса = ТекущаяДата();
    
    // Запрос для поиска просроченных партий через регистр ОстаткиНаСкладе
    Запрос = Новый Запрос;
    Запрос.Текст = 
        "ВЫБРАТЬ
        |   ОстаткиНаСкладеОстатки.Партия КАК Партия,
        |   ОстаткиНаСкладеОстатки.Лекарство КАК Лекарство,
        |   ОстаткиНаСкладеОстатки.КоличествоОстаток КАК КоличествоОстаток
        |ПОМЕСТИТЬ ВТОстатки
        |ИЗ
        |   РегистрНакопления.ОстаткиНаСкладе.Остатки(&ТекущаяДата, ) КАК ОстаткиНаСкладеОстатки
        |ГДЕ
        |   ОстаткиНаСкладеОстатки.КоличествоОстаток > 0
        |;
        |
        |ВЫБРАТЬ
        |   ВТОстатки.Партия КАК Партия,
        |   ВТОстатки.Лекарство КАК Лекарство,
        |   ВТОстатки.КоличествоОстаток КАК КоличествоОстаток,
        |   ПартииЛекарствСоставПартии.СрокГодности КАК СрокГодности,
        |   ПартииЛекарств.Дата КАК ДатаПоступления
        |ИЗ
        |   ВТОстатки КАК ВТОстатки
        |   ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПартииЛекарств.СоставПартии КАК ПартииЛекарствСоставПартии
        |   ПО ВТОстатки.Партия = ПартииЛекарствСоставПартии.Ссылка
        |   И ВТОстатки.Лекарство = ПартииЛекарствСоставПартии.Лекарство
        |   ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПартииЛекарств КАК ПартииЛекарств
        |   ПО ВТОстатки.Партия = ПартииЛекарств.Ссылка
        |ГДЕ
        |   ПартииЛекарствСоставПартии.СрокГодности < &ТекущаяДата";
    
    Запрос.УстановитьПараметр("ТекущаяДата", ТекущаяДатаСеанса);
    Выборка = Запрос.Выполнить().Выбрать();
    
    // Создаём документ СписаниеПросрочки
    ДокументСписание = Документы.СписаниеПросрочки.СоздатьДокумент();
    ДокументСписание.Дата = ТекущаяДатаСеанса;
    
    КоличествоСписано = 0;
    
    // Начинаем транзакцию
    НачатьТранзакцию();
    Попытка
        // Обрабатываем каждую просроченную партию
        Пока Выборка.Следующий() Цикл
            Если Выборка.КоличествоОстаток <= 0 Тогда
                Продолжить;
            КонецЕсли;
            
            // Блокируем данные в регистре
            Блокировка = Новый БлокировкаДанных;
            ЭлементБлокировки = Блокировка.Добавить("РегистрНакопления.ОстаткиНаСкладе");
            ЭлементБлокировки.УстановитьЗначение("Партия", Выборка.Партия);
            ЭлементБлокировки.УстановитьЗначение("Лекарство", Выборка.Лекарство);
            Блокировка.Заблокировать();
            
            // Добавляем строку в табличную часть документа
            НоваяСтрока = ДокументСписание.ПросроченныеПартии.Добавить();
            НоваяСтрока.Партия = Выборка.Партия;
            НоваяСтрока.Лекарство = Выборка.Лекарство;
            НоваяСтрока.Количество = Выборка.КоличествоОстаток;
            НоваяСтрока.СрокГодности = Выборка.СрокГодности;
            
            КоличествоСписано = КоличествоСписано + Выборка.КоличествоОстаток;
            Сообщить("Списана просроченная партия: " + Выборка.Партия + " (Лекарство: " + Выборка.Лекарство + ", Количество: " + Выборка.КоличествоОстаток + ", Срок годности: " + Выборка.СрокГодности + ")", СтатусСообщения.Информация);
        КонецЦикла;
        
        // Проверяем и записываем документ
        Если ДокументСписание.ПросроченныеПартии.Количество() > 0 Тогда
            ДокументСписание.Записать(РежимЗаписиДокумента.Проведение);
            Сообщить("Документ списания успешно проведён.", СтатусСообщения.Информация);
            Успешно = Истина; // Устанавливаем флаг успешного выполнения
        КонецЕсли;
        
        // Фиксируем транзакцию
        ЗафиксироватьТранзакцию();
    Исключение
        // Откат транзакции при ошибке
        Если ТранзакцияАктивна() Тогда
            ОтменитьТранзакцию();
        КонецЕсли;
        Сообщить("Ошибка при обработке: " + ОписаниеОшибки(), СтатусСообщения.Важное);
        Успешно = Ложь; // Устанавливаем флаг неуспешного выполнения
        Возврат;
    КонецПопытки;
    
    // Выводим результат
    Если КоличествоСписано = 0 Тогда
        Сообщить("Просроченных лекарств не найдено.", СтатусСообщения.Информация);
    Иначе
        Сообщить("Списание завершено. Всего списано: " + КоличествоСписано + " единиц.", СтатусСообщения.Информация);
    КонецЕсли;
КонецПроцедуры