// Модуль объекта документа СписаниеПросрочки

Процедура ОбработкаПроведения(Отказ, Режим)
    НачатьТранзакцию();
    Попытка
        // Блокировка данных
        Блокировка = Новый БлокировкаДанных;
        Для Каждого СтрокаТЧ Из ПросроченныеПартии Цикл
            ЭлементБлокировки = Блокировка.Добавить("РегистрНакопления.ОстаткиНаСкладе");
            ЭлементБлокировки.УстановитьЗначение("Партия", СтрокаТЧ.Партия);
            ЭлементБлокировки.УстановитьЗначение("Лекарство", СтрокаТЧ.Лекарство);
        КонецЦикла;
        Блокировка.Заблокировать();
        
        Движения.ОстаткиНаСкладе.Записывать = Истина;
        
        Для Каждого СтрокаТЧ Из ПросроченныеПартии Цикл
            Если Не ЗначениеЗаполнено(СтрокаТЧ.Партия) Или Не ЗначениеЗаполнено(СтрокаТЧ.Лекарство) Или СтрокаТЧ.Количество <= 0 Тогда
                Сообщить("Ошибка: Некорректные данные в строке табличной части для партии " + СтрокаТЧ.Партия + ". Строка пропущена.", СтатусСообщения.Важное);
                Продолжить;
            КонецЕсли;
            
            Движение = Движения.ОстаткиНаСкладе.Добавить();
            Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
            Движение.Период = Дата;
            Движение.Лекарство = СтрокаТЧ.Лекарство;
            Движение.Партия = СтрокаТЧ.Партия;
            Движение.Количество = СтрокаТЧ.Количество;
            Движение.ДатаПоступления = СтрокаТЧ.Партия.Дата; // Теперь это документ ПартииЛекарств
            Движение.СрокГодности = СтрокаТЧ.СрокГодности;
        КонецЦикла;
        
        Движения.ОстаткиНаСкладе.Записать();
        
        ЗафиксироватьТранзакцию();
    Исключение
        Если ТранзакцияАктивна() Тогда
            ОтменитьТранзакцию();
        КонецЕсли;
        Отказ = Истина;
        Сообщить("Ошибка при проведении: " + ОписаниеОшибки(), СтатусСообщения.Важное);
    КонецПопытки;
КонецПроцедуры